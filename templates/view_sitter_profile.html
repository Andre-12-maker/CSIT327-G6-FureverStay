{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ profile.first_name }} {{ profile.last_name }} | FureverStay</title>
  <link rel="icon" type="image/png" href="{% static 'assets/icon.png' %}" />
  <link rel="stylesheet" href="{% static 'css/view_sitter_profile.css' %}">
</head>
<body>
  {% include 'navbar_owner.html' %}

  {% if error %}
    <p class="error">{{ error }}</p>
  {% else %}
  <main class="profile-container">

    <!-- Header Section -->
    <section class="profile-header">
      <img 
        src="{% if sitter_profile and sitter_profile.profile_image_url %}{{ sitter_profile.profile_image_url }}{% else %}{% static 'assets/default_profile.png' %}{% endif %}" 
        alt="{{ profile.first_name }}'s Photo"
      >
      <div class="profile-info">
        <h2>{{ profile.first_name }} {{ profile.last_name }}</h2>
        <p>{{ sitter_profile.bio|default:"No bio available." }}</p>
        <p>üìç {{ profile.address|default:"No address listed" }}</p>
        <p>üí¨ Experience: {{ sitter_profile.experience_years|default:"Not specified" }} years</p>
        <p class="rate">‚Ç±{{ sitter_profile.hourly_rate|default:"‚Äî" }} / hr</p>
        <button class="book-btn" data-hourly-rate="{{ sitter_profile.hourly_rate|default:0 }}">Book Now</button>
      </div>
    </section>

    <!-- Availability Section -->
    <section class="availability-section">
      <h4>Availability Calendar</h4>
      <div class="calendar-container">
        <div class="calendar-header">
          <button id="prevMonth">‚óÄ</button>
          <h3 id="monthYear"></h3>
          <button id="nextMonth">‚ñ∂</button>
        </div>
        <table class="calendar" id="availabilityCalendar">
          <thead>
            <tr>
              <th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th>
            </tr>
          </thead>
          <tbody id="calendarBody" data-sitter-id="{{ sitter_id }}"></tbody>
        </table>
      </div>
    </section>
    <!-- Reviews Section -->
    <section class="reviews-section">
      <h4>Reviews & Ratings</h4>
      
      <!-- Average Rating -->
      <div class="average-rating">
        <strong>Average Rating:</strong> {{ avg_rating }} / 5
        <span class="stars">
          {% for i in "12345"|slice:":5" %}
            {% if forloop.counter <= avg_rating|floatformat:0 %}
              ‚òÖ
            {% else %}
              ‚òÜ
            {% endif %}
          {% endfor %}
        </span>
      </div>

      <!-- List of reviews -->
      <div class="review-list">
        {% if reviews %}
          {% for review in reviews %}
            <div class="review-card">
              <p><strong>{{ review.reviewer.first_name }} {{ review.reviewer.last_name }}</strong> - {{ review.rating }} ‚òÖ</p>
              <p>{{ review.comment }}</p>
              <p class="review-date">{{ review.created_at|date:"M d, Y" }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p>No reviews yet.</p>
        {% endif %}
      </div>
    </section>
    <!-- Submit Review Section -->
    <section class="submit-review-section">
      <h4>Leave a Review</h4>
      
      {% if request.user.id != sitter_id %}
      <form method="POST" action="{% url 'submit_review' sitter_id %}">
        {% csrf_token %}
        
        <label for="rating">Rating:</label>
        <select name="rating" id="rating" required>
          <option value="">Select rating</option>
          <option value="1">1 ‚òÖ</option>
          <option value="2">2 ‚òÖ</option>
          <option value="3">3 ‚òÖ</option>
          <option value="4">4 ‚òÖ</option>
          <option value="5">5 ‚òÖ</option>
        </select>

        <label for="comment">Comment:</label>
        <textarea name="comment" id="comment" rows="3" placeholder="Write your review here..."></textarea>

        <button type="submit" class="submit-review-btn">Submit Review</button>
      </form>
      {% else %}
        <p>You cannot review yourself.</p>
      {% endif %}
    </section>

  </main>
  {% endif %}

  <!-- Booking Modal -->
  <div id="bookingModal" class="modal hidden">
    <div class="modal-content">
      <h3>Book {{ profile.first_name }}</h3>
      <form method="POST" action="{% url 'create_booking' profile.user_id %}" id="bookingForm">
        {% csrf_token %}
        <label for="start_date">Start Date:</label>
        <input type="date" name="start_date" id="start_date" required>

        <label for="end_date">End Date:</label>
        <input type="date" name="end_date" id="end_date" required>

        <label for="hours_per_day">Hours per day:</label>
        <input type="number" name="hours_per_day" id="hours_per_day" min="1" max="24" value="1" required>

        <label for="selected_pets">Select Pets</label>
        <div class="pet-list">
          {% for pet in pets %}
            <div>
              <input type="checkbox" name="pets" value="{{ pet.id }}" id="pet{{ pet.id }}">
              <label for="pet{{ pet.id }}">{{ pet.pet_name }} ({{ pet.species }})</label>
            </div>
          {% empty %}
            <p>You have no pets added yet.</p>
          {% endfor %}
        </div>

        <p class="total-price"><strong>Total Price:</strong> ‚Ç±<span id="totalPrice">0.00</span></p>

        <div class="modal-actions">
          <button type="submit" class="confirm-btn">Confirm Booking</button>
          <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="{% static 'js/pet_owner_dashboardv2.js' %}"></script>
</body>
</html>
